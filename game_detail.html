<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Detail | L-crown</title>

<style>
body{
  font-family:"Segoe UI","Noto Sans JP",sans-serif;
  background: radial-gradient(circle at top,#163b80 0%,#091b3d 40%,#050c1f 100%);
  color:white;
  margin:0;
}
main{max-width:1300px;margin:40px auto;padding:20px;}
.card{
  background:rgba(255,255,255,.06);
  padding:20px;border-radius:20px;margin-bottom:20px;
}
select{background:#13234f;color:white;padding:6px 8px;border-radius:6px;}
button{background:#4da3ff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;}
.result-item{padding:6px;border-bottom:1px solid rgba(255,255,255,.1);cursor:pointer;}
.result-item:hover{background:rgba(77,163,255,.3);}
.zone{width:200px;height:200px;border:2px solid white;position:relative;margin-top:10px;}
.pitch-dot{width:10px;height:10px;border-radius:50%;position:absolute;transform:translate(-50%,-50%);}
</style>
</head>
<body>
<main>

<div class="card">
<h2 id="title"></h2>

<select id="teamFilter">
<option value="all">全打席</option>
<option value="L">ライオンズ攻撃</option>
<option value="H">ライオンズ守備</option>
</select>

<select id="playerFilter">
<option value="">選手指定なし</option>
</select>

<button onclick="applyFilter()">検索</button>

</div>

<div class="card">
<h3>検索結果</h3>
<div id="results"></div>
</div>

<div class="card">
<h3>打席詳細</h3>
<div id="detail"></div>
</div>

<div class="card">
<h3>統計</h3>
<div id="stats"></div>
</div>

</main>

<script>
let gameData;
let allEvents=[];
let filteredEvents=[];

const pitchColors={
  "FF":"#ff4d4d",
  "SL":"#4da3ff",
  "CT":"#ffd700"
};

document.addEventListener("DOMContentLoaded",async()=>{
  const p=new URLSearchParams(location.search);
  const date=p.get("date");
  const team=p.get("team");

  const res=await fetch(`live/${date}_${team}.json`);
  gameData=await res.json();

  initGame();
});

function initGame(){
  document.getElementById("title").innerText=
    `${gameData.game.date} ${gameData.teams.L.name} vs ${gameData.teams.H.name}`;

  allEvents=gameData.events;
  populatePlayers();
  applyFilter();
}

function populatePlayers(){
  const pf=document.getElementById("playerFilter");
  Object.entries(gameData.players).forEach(([id,p])=>{
    pf.innerHTML+=`<option value="${id}">${p.name}</option>`;
  });
}

function applyFilter(){
  const team=document.getElementById("teamFilter").value;
  const player=document.getElementById("playerFilter").value;

  filteredEvents=allEvents.filter(ev=>{
    if(team!=="all" && ev.offense!==team) return false;
    if(player && ev.batter!==player && ev.pitcher!==player) return false;
    return true;
  });

  renderResults();
  calcStats();
}

function renderResults(){
  const area=document.getElementById("results");
  area.innerHTML="";
  filteredEvents.forEach((ev,i)=>{
    area.innerHTML+=`
    <div class="result-item" onclick="showDetail(${i})">
      ${ev.inning}回${ev.half==="top"?"表":"裏"} ｜ 
      ${gameData.players[ev.batter].name} ｜ 
      ${ev.result.type}
    </div>`;
  });
}

function showDetail(i){
  const ev=filteredEvents[i];
  if(!ev) return;

  let zone="<div class='zone'>";
  ev.pitches.forEach(p=>{
    if(p.zone){
      zone+=`<div class="pitch-dot"
      style="left:${p.zone.x}%;top:${p.zone.y}%;
      background:${pitchColors[p.type]||'white'}"></div>`;
    }
  });
  zone+="</div>";

  document.getElementById("detail").innerHTML=`
    <div>
    打者:${gameData.players[ev.batter].name}<br>
    投手:${gameData.players[ev.pitcher].name}<br>
    結果:${ev.result.type}<br>
    ${zone}
    </div>
  `;
}

function calcStats(){
  let mix={};
  let sum=0,count=0;

  filteredEvents.forEach(ev=>{
    ev.pitches.forEach(p=>{
      mix[p.type]=(mix[p.type]||0)+1;
      if(p.speed){sum+=p.speed;count++;}
    });
  });

  let html="球種割合:<br>";
  for(let k in mix){
    html+=`${k} : ${mix[k]}球<br>`;
  }
  html+=`平均球速: ${count?(sum/count).toFixed(1):"-"} km/h`;

  document.getElementById("stats").innerHTML=html;
}
</script>

</body>
</html>
