<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Detail</title>

<style>
body{
  margin:0;
  font-family:"Segoe UI","Noto Sans JP",sans-serif;
  background:#0b1d3a;
  color:#fff;
}

/* ===== レイアウト ===== */
.container{
  display:grid;
  grid-template-columns: 320px 1fr 360px;
  gap:20px;
  padding:20px;
}

.panel{
  background:rgba(255,255,255,0.05);
  padding:15px;
  border-radius:16px;
}

/* ===== スコアボード ===== */
.scoreboard{
  padding:15px;
  background:rgba(255,255,255,0.08);
  border-radius:20px;
  margin:20px;
  display:flex;
  justify-content:space-between;
}

/* ===== 打席一覧 ===== */
.atbat-item{
  padding:8px;
  margin-bottom:6px;
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  cursor:pointer;
}

.atbat-item:hover{
  background:rgba(255,255,255,0.15);
}

/* ===== ゾーン ===== */
#zoneCanvas{
  background:#111;
  border:2px solid #fff;
}

/* ===== 結果カード ===== */
.result-card{
  background:rgba(255,255,255,0.06);
  padding:10px;
  margin-bottom:8px;
  border-radius:12px;
}

/* ===== ボタン ===== */
button{
  background:#1f6feb;
  border:none;
  padding:6px 12px;
  border-radius:8px;
  color:#fff;
  cursor:pointer;
}
button:hover{
  background:#3b82f6;
}
input,select{
  width:100%;
  margin-bottom:6px;
}
</style>
</head>
<body>

<div class="scoreboard" id="scoreboard"></div>

<div class="container">

<!-- 左：打席ログ -->
<div class="panel">
  <h3>打席一覧</h3>
  <div id="atbatList"></div>
</div>

<!-- 中央：打席詳細 -->
<div class="panel">
  <h3>打席詳細</h3>
  <div id="atbatDetail"></div>
  <canvas id="zoneCanvas" width="250" height="250"></canvas>
  <div style="margin-top:10px;">
    <button onclick="prevAtBat()">前へ</button>
    <button onclick="nextAtBat()">次へ</button>
  </div>
</div>

<!-- 右：統計 -->
<div class="panel">
  <h3>統計</h3>
  <div id="statsPanel"></div>
</div>

</div>

<!-- 検索 -->
<div class="panel" style="margin:20px;">
  <h3>検索</h3>
  <select id="teamFilter">
    <option value="">チーム</option>
    <option value="L">L</option>
    <option value="H">H</option>
  </select>
  <input id="playerFilter" placeholder="選手ID">
  <select id="resultFilter">
    <option value="">結果</option>
    <option value="single">single</option>
    <option value="out">out</option>
  </select>
  <button onclick="searchEvents()">検索</button>
  <div id="searchResults"></div>
</div>

<script>

let gameData
let currentIndex = 0

fetch("live/2026-03-01_L_H.json")
.then(res=>res.json())
.then(data=>{
  gameData = data
  renderScoreboard()
  renderAtBatList()
  renderAtBat(0)
})

function renderScoreboard(){
  document.getElementById("scoreboard").innerHTML =
    gameData.teams.L + " vs " + gameData.teams.H
}

function renderAtBatList(){
  const list = document.getElementById("atbatList")
  list.innerHTML=""
  gameData.events.forEach((ev,i)=>{
    list.innerHTML+=`
      <div class="atbat-item" onclick="renderAtBat(${i})">
        ${ev.inning}回 ${ev.half} ${ev.batter} ${ev.result.type}
      </div>
    `
  })
}

function renderAtBat(i){
  currentIndex=i
  const ev = gameData.events[i]
  document.getElementById("atbatDetail").innerHTML =
    `打者:${ev.batter}<br>
     投手:${ev.pitcher}<br>
     結果:${ev.result.type}`
  drawZone(ev)
  calcStats(ev.pitcher)
}

function drawZone(ev){
  const canvas=document.getElementById("zoneCanvas")
  const ctx=canvas.getContext("2d")
  ctx.clearRect(0,0,250,250)

  ctx.strokeStyle="white"
  ctx.strokeRect(75,50,100,150)

  ev.pitches.forEach(p=>{
    ctx.fillStyle=getPitchColor(p.type)
    ctx.beginPath()
    ctx.arc(125+p.zone.x*80,125-p.zone.y*80,5,0,2*Math.PI)
    ctx.fill()
  })
}

function getPitchColor(type){
  if(type==="FF") return "red"
  if(type==="SL") return "blue"
  return "white"
}

function prevAtBat(){
  if(currentIndex>0) renderAtBat(currentIndex-1)
}
function nextAtBat(){
  if(currentIndex<gameData.events.length-1) renderAtBat(currentIndex+1)
}

function searchEvents(){
  const team=document.getElementById("teamFilter").value
  const player=document.getElementById("playerFilter").value
  const result=document.getElementById("resultFilter").value

  const results=gameData.events.filter(ev=>{
    if(team && ev.offense!==team) return false
    if(player && ev.batter!==player && ev.pitcher!==player) return false
    if(result && ev.result.type!==result) return false
    return true
  })

  const container=document.getElementById("searchResults")
  container.innerHTML=""
  results.forEach(ev=>{
    container.innerHTML+=`
      <div class="result-card">
        ${ev.inning}回 ${ev.half} ${ev.batter} ${ev.result.type}
      </div>
    `
  })
}

function calcStats(pitcherId){
  const pitches=[]
  gameData.events.forEach(ev=>{
    if(ev.pitcher===pitcherId){
      pitches.push(...ev.pitches)
    }
  })
  const avg = pitches.reduce((a,b)=>a+b.velocity,0)/pitches.length
  document.getElementById("statsPanel").innerHTML=
    `投球数:${pitches.length}<br>
     平均球速:${avg.toFixed(1)}km`
}

</script>
</body>
</html>
