<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Hub | L-crown</title>

<link rel="icon" type="image/webp" href="https://lions-crown.homep.jp/img/1766145327164.webp">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:"Segoe UI","Noto Sans JP",sans-serif;
  background: radial-gradient(circle at top,#163b80 0%,#091b3d 40%,#050c1f 100%);
  color:white;
}
main{max-width:1200px;margin:40px auto;padding:20px;}
.glass{
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(18px);
  border-radius:24px;
  padding:30px;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
}

/* Scoreboard */
.scoreboard{width:100%;border-collapse:collapse;margin-bottom:25px;}
.scoreboard th,.scoreboard td{
  border:1px solid rgba(255,255,255,.15);
  padding:6px;text-align:center;font-size:13px;
}

/* Count */
.count{display:flex;gap:6px;margin:10px 0;}
.dot{width:14px;height:14px;border-radius:50%;border:1px solid white;}
.b{background:#4da3ff;}
.s{background:#ffd700;}
.o{background:#ff4d4d;}

/* Zone */
.zone{
  width:180px;height:180px;border:2px solid white;
  display:grid;grid-template-columns:repeat(3,1fr);
  grid-template-rows:repeat(3,1fr);
  margin-top:20px;position:relative;
}
.zone div{border:1px solid rgba(255,255,255,.2);}
.pitch-dot{
  width:12px;height:12px;border-radius:50%;
  position:absolute;transform:translate(-50%,-50%);
  background:#ff4d4d;
}

/* Nav */
.atbat-nav{display:flex;justify-content:center;gap:20px;margin:20px 0;}
.nav-btn{
  background:#1f2d55;padding:6px 14px;border-radius:10px;
  cursor:pointer;font-size:13px;
}
.nav-btn:hover{background:#4da3ff;color:black;}

/* Defense */
.field{
  position:relative;width:300px;height:260px;
  margin:30px auto;background:radial-gradient(circle at center,#0a3c2f,#08251f);
  border-radius:50% 50% 0 0;
}
.pos{position:absolute;font-size:11px;text-align:center;}

/* Lineup */
.lineup{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-top:30px;}
.lineup-card{
  background:rgba(255,255,255,.06);
  padding:15px;border-radius:18px;
}
.player-row{
  display:flex;justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.1);
  padding:4px 0;font-size:13px;
}
</style>
</head>

<body>
<main>
<div class="glass">

<h1 id="title"></h1>
<div id="scoreboard"></div>
<div id="liveArea"></div>
<div id="atbatNav"></div>
<div id="defenseMap"></div>
<div id="lineupArea"></div>

</div>
</main>

<script>
let gameData;
let atBatsFlat=[];
let currentAtBat=0;

document.addEventListener("DOMContentLoaded",async()=>{
  const p=new URLSearchParams(location.search);
  const date=p.get("date");
  const team=p.get("team");

  if(!date||!team){
    document.body.innerHTML="試合指定がありません";
    return;
  }

  try{
    const res=await fetch(`/lionscrown/live/${date}_${team}.json`);
    gameData=await res.json();

    flattenAtBats();
    renderGame();
  }catch(e){
    document.body.innerHTML="データ取得失敗";
  }
});

/* innings → atBatsをフラット化 */
function flattenAtBats(){
  if(!gameData.innings) return;
  gameData.innings.forEach(inning=>{
    inning.atBats.forEach(ab=>{
      atBatsFlat.push({
        inning:`${inning.number}回${inning.half==="top"?"表":"裏"}`,
        batter:ab.batter,
        pitcher:ab.pitcher,
        count:ab.startCount,
        result:ab.result,
        pitches:ab.pitches
      });
    });
  });
}

function renderGame(){
  document.getElementById("title").innerText=
    `${gameData.meta.card} ｜ ${gameData.meta.stadium}`;

  renderScoreboard();
  renderAtBat(currentAtBat);
  renderDefense();
  renderLineup();
}

function renderScoreboard(){
  const s=gameData.score;
  let sb="<table class='scoreboard'><tr><th></th>";
  for(let i=1;i<=9;i++) sb+=`<th>${i}</th>`;
  sb+="<th>R</th><th>H</th><th>E</th></tr>";

  const sumL=s.lions.reduce((a,b)=>a+b,0);
  const sumO=s.opp.reduce((a,b)=>a+b,0);

  const pad=(arr)=>[...arr,...Array(9-arr.length).fill("")].slice(0,9);

  sb+=`<tr><td>L</td>${pad(s.lions).map(i=>`<td>${i}</td>`).join("")}
  <td>${sumL}</td><td>${s.hits?.lions||0}</td><td>${s.errors?.lions||0}</td></tr>`;

  sb+=`<tr><td>O</td>${pad(s.opp).map(i=>`<td>${i}</td>`).join("")}
  <td>${sumO}</td><td>${s.hits?.opp||0}</td><td>${s.errors?.opp||0}</td></tr>`;

  sb+="</table>";
  document.getElementById("scoreboard").innerHTML=sb;
}

function renderAtBat(index){
  if(atBatsFlat.length===0) return;
  const ab=atBatsFlat[index];

  let countHTML="<div class='count'>";
  for(let i=0;i<ab.count.balls;i++) countHTML+="<div class='dot b'></div>";
  for(let i=0;i<ab.count.strikes;i++) countHTML+="<div class='dot s'></div>";
  for(let i=0;i<ab.count.outs;i++) countHTML+="<div class='dot o'></div>";
  countHTML+="</div>";

  let zone="<div class='zone'>";
  for(let i=0;i<9;i++) zone+="<div></div>";

  ab.pitches.forEach(p=>{
    if(p.zone){
      zone+=`<div class="pitch-dot" style="left:${p.zone.x}%;top:${p.zone.y}%"></div>`;
    }
  });

  zone+="</div>";

  document.getElementById("liveArea").innerHTML=`
    <h2>${ab.inning}</h2>
    <p>打者：${ab.batter} ｜ 投手：${ab.pitcher}</p>
    ${countHTML}
    ${zone}
    <p>結果：${ab.result}</p>
  `;

  document.getElementById("atbatNav").innerHTML=`
    <div class="atbat-nav">
      <div class="nav-btn" onclick="changeAtBat(-1)">◀</div>
      <div>${index+1} / ${atBatsFlat.length}</div>
      <div class="nav-btn" onclick="changeAtBat(1)">▶</div>
    </div>
  `;
}

function changeAtBat(dir){
  currentAtBat+=dir;
  if(currentAtBat<0) currentAtBat=0;
  if(currentAtBat>=atBatsFlat.length)
    currentAtBat=atBatsFlat.length-1;
  renderAtBat(currentAtBat);
}

function renderDefense(){
  const d=gameData.defense;
  if(!d)return;

  document.getElementById("defenseMap").innerHTML=`
    <div class="field">
      <div class="pos" style="top:20px;left:50%">${d.CF}</div>
      <div class="pos" style="top:60px;left:20%">${d.LF}</div>
      <div class="pos" style="top:60px;right:20%">${d.RF}</div>
      <div class="pos" style="top:120px;left:50%">${d.SS}</div>
      <div class="pos" style="top:140px;left:20%">${d["3B"]}</div>
      <div class="pos" style="top:140px;right:20%">${d["1B"]}</div>
      <div class="pos" style="top:180px;left:50%">${d.P}</div>
      <div class="pos" style="top:210px;left:50%">${d.C}</div>
    </div>
  `;
}

function renderLineup(){
  const l=gameData.lineup;
  if(!l)return;

  let html="<div class='lineup'>";

  html+="<div class='lineup-card'><h3>ライオンズ</h3>";
  l.lions.forEach(p=>{
    html+=`<div class="player-row">
      <span>${p.order} ${p.pos} ${p.name}</span>
      <span>${p.avg}</span>
    </div>`;
  });
  html+=`<div class="player-row">
    <span>投 ${l.pitcher.name}</span>
    <span>ERA ${l.pitcher.era}</span>
  </div></div>`;

  html+="</div>";

  document.getElementById("lineupArea").innerHTML=html;
}
</script>

</body>
</html>
